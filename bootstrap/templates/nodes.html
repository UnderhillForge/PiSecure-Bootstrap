<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PiSecure Network Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: linear-gradient(45deg, #00d4ff, #090979);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 212, 255, 0.3);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .recent-blocks-card {
            grid-column: span 2; /* Make Recent Blocks twice as wide */
        }

        .card {
            background: rgba(30, 30, 30, 0.8);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 212, 255, 0.2);
            border-color: rgba(0, 212, 255, 0.4);
        }

        .card h3 {
            color: #00d4ff;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid rgba(0, 212, 255, 0.3);
            padding-bottom: 8px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .metric:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .metric-label {
            font-weight: 500;
            color: #b0b0b0;
        }

        .metric-value {
            font-weight: bold;
            color: #00d4ff;
            font-size: 1.1em;
        }

        .status-healthy {
            color: #00ff88;
        }

        .status-warning {
            color: #ffaa00;
        }

        .status-error {
            color: #ff4444;
        }

        .status-initializing {
            color: #888888;
        }

        .blocks-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .blocks-table th,
        .blocks-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .blocks-table th {
            color: #00d4ff;
            font-weight: 600;
        }

        .blocks-table td {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .hash-cell {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            background: rgba(20, 20, 20, 0.8);
            border-radius: 10px;
            border: 1px solid rgba(0, 212, 255, 0.2);
        }

        .footer p {
            color: #888;
            font-size: 0.9em;
        }

        .last-updated {
            font-size: 0.8em;
            color: #666;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2em;
            }
        }

        /* Pulse animation removed per user request */
        /*
        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        */

        /* Operator Value Estimation Section */
        .operator-value-section {
            margin: 30px auto;
            max-width: 1000px;
        }

        .operator-value-section .card {
            background: linear-gradient(135deg, rgba(30, 30, 30, 0.9) 0%, rgba(20, 20, 20, 0.9) 100%);
            border: 1px solid rgba(255, 193, 7, 0.3);
            box-shadow: 0 8px 32px rgba(255, 193, 7, 0.2);
        }

        .operator-value-section .card h3 {
            color: #ffc107;
            border-bottom-color: rgba(255, 193, 7, 0.3);
        }

        .value-metrics {
            margin-bottom: 20px;
        }

        .value-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .value-row:last-child {
            border-bottom: none;
        }

        .value-label {
            font-weight: 500;
            color: #b0b0b0;
            font-size: 0.95em;
        }

        .value-amount {
            font-weight: bold;
            color: #ffc107;
            font-size: 1.2em;
            font-family: 'Courier New', monospace;
        }

        .value-breakdown h4 {
            color: #ffc107;
            margin-bottom: 15px;
            font-size: 1.1em;
            border-bottom: 2px solid rgba(255, 193, 7, 0.3);
            padding-bottom: 8px;
        }

        .breakdown-list {
            margin-bottom: 20px;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .breakdown-item:last-child {
            border-bottom: none;
        }

        .breakdown-label {
            color: #e0e0e0;
            font-size: 0.9em;
            flex: 1;
            margin-right: 15px;
        }

        .breakdown-value {
            color: #ffc107;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .value-disclaimer {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.2);
            border-radius: 6px;
            padding: 12px;
            margin-top: 15px;
        }

        .value-disclaimer p {
            color: #ddd;
            font-size: 0.8em;
            line-height: 1.4;
            margin: 0;
        }

        /* 314ST Token Valuation Section */
        .token-valuation-section {
            margin: 30px auto;
            max-width: 1000px;
        }

        .token-valuation-section .card {
            background: linear-gradient(135deg, rgba(30, 30, 30, 0.9) 0%, rgba(20, 20, 20, 0.9) 100%);
            border: 1px solid rgba(255, 193, 7, 0.3);
            box-shadow: 0 8px 32px rgba(255, 193, 7, 0.2);
        }

        .token-valuation-section .card h3 {
            color: #ffc107;
            border-bottom-color: rgba(255, 193, 7, 0.3);
        }

        .token-valuation-section .card h4 {
            color: #ffc107;
            margin-bottom: 15px;
            font-size: 1.1em;
            border-bottom: 2px solid rgba(255, 193, 7, 0.3);
            padding-bottom: 8px;
        }

        .price-overview {
            margin-bottom: 20px;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .price-row:last-child {
            border-bottom: none;
        }

        .price-label {
            font-weight: 500;
            color: #b0b0b0;
            font-size: 0.95em;
        }

        .price-amount {
            font-weight: bold;
            color: #ffc107;
            font-size: 1.2em;
            font-family: 'Courier New', monospace;
        }

        .price-status {
            color: #888;
            font-size: 0.9em;
        }

        .launch-status {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .status-row:last-child {
            border-bottom: none;
        }

        .status-label {
            font-weight: 500;
            color: #b0b0b0;
            font-size: 0.9em;
        }

        .status-value {
            color: #ffc107;
            font-weight: bold;
            font-size: 0.9em;
        }

        .market-data, .supply-demand {
            margin-bottom: 20px;
        }

        .market-grid, .supply-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .market-item, .supply-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            padding: 12px;
        }

        .market-label, .supply-label {
            display: block;
            color: #b0b0b0;
            font-size: 0.8em;
            margin-bottom: 5px;
        }

        .market-value, .supply-value {
            display: block;
            color: #ffc107;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            font-size: 1em;
        }

        .valuation-breakdown {
            margin-bottom: 20px;
        }

        .sentiment-indicators {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .sentiment-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            padding: 12px;
        }

        .sentiment-label {
            display: block;
            color: #b0b0b0;
            font-size: 0.8em;
            margin-bottom: 5px;
        }

        .sentiment-value {
            display: block;
            color: #ffc107;
            font-weight: bold;
            font-size: 0.9em;
        }

        .valuation-disclaimer {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.2);
            border-radius: 6px;
            padding: 12px;
            margin-top: 15px;
        }

        .valuation-disclaimer p {
            color: #ddd;
            font-size: 0.8em;
            line-height: 1.4;
            margin: 0;
        }

        @media (max-width: 768px) {
            .token-valuation-section {
                margin: 20px 10px;
            }

            .price-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }

            .status-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }

            .market-grid, .supply-grid, .sentiment-indicators {
                grid-template-columns: 1fr;
            }

            .operator-value-section {
                margin: 20px 10px;
            }

            .value-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }

            .breakdown-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }

            .breakdown-value {
                align-self: flex-end;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîó PiSecure Network Dashboard</h1>
        <p>Real-time blockchain network statistics and node information</p>
    </div>

    <div class="grid">
        <!-- Network Overview -->
        <div class="card" id="networkOverviewCard">
            <h3>üåê Network Overview</h3>
            <div class="metric">
                <span class="metric-label">Total Nodes</span>
                <span class="metric-value" id="totalNodes">--</span>
            </div>
            <div class="metric">
                <span class="metric-label">Active Nodes</span>
                <span class="metric-value status-healthy" id="activeNodes">--</span>
            </div>
            <div class="metric">
                <span class="metric-label">Network Hashrate</span>
                <span class="metric-value" id="networkHashrate">-- MH/s</span>
            </div>
            <div class="metric">
                <span class="metric-label">Block Height</span>
                <span class="metric-value" id="blockHeight">--</span>
            </div>
            <div class="metric">
                <span class="metric-label">Average Block Time</span>
                <span class="metric-value" id="avgBlockTime">--s</span>
            </div>
            <div class="metric">
                <span class="metric-label">Network Status</span>
                <span class="metric-value status-healthy" id="networkStatus">--</span>
            </div>
        </div>

        <!-- Network Health -->
        <div class="card" id="networkHealthCard">
            <h3>üíö Network Health</h3>
            <div class="metric">
                <span class="metric-label">Health Status</span>
                <span class="metric-value status-healthy" id="healthStatus">--</span>
            </div>
            <div class="metric">
                <span class="metric-label">Average Latency</span>
                <span class="metric-value" id="avgLatency">--ms</span>
            </div>
            <div class="metric">
                <span class="metric-label">Packet Loss</span>
                <span class="metric-value" id="packetLoss">--%</span>
            </div>
            <div class="metric">
                <span class="metric-label">Sync Status</span>
                <span class="metric-value status-healthy" id="syncStatus">--</span>
            </div>
            <div class="metric">
                <span class="metric-label">Mempool Size</span>
                <span class="metric-value" id="mempoolSize">--</span>
            </div>
            <div class="metric">
                <span class="metric-label">Pending Transactions</span>
                <span class="metric-value" id="pendingTransactions">--</span>
            </div>
        </div>

        <!-- Mining Statistics -->
        <div class="card" id="miningStatsCard">
            <h3>‚õèÔ∏è Mining Statistics</h3>
            <div class="metric">
                <span class="metric-label">Active Miners</span>
                <span class="metric-value" id="activeMiners">--</span>
            </div>
            <div class="metric">
                <span class="metric-label">Total Hashrate</span>
                <span class="metric-value" id="totalHashrate">-- MH/s</span>
            </div>
            <div class="metric">
                <span class="metric-label">Blocks Last Hour</span>
                <span class="metric-value" id="blocksLastHour">--</span>
            </div>
            <div class="metric">
                <span class="metric-label">Avg Blocks/Hour</span>
                <span class="metric-value" id="avgBlocksPerHour">--</span>
            </div>
            <div class="metric">
                <span class="metric-label">Top Miners</span>
                <span class="metric-value" id="topMiners">--</span>
            </div>
        </div>

        <!-- Protocol Information -->
        <div class="card" id="protocolInfoCard">
            <h3>üìã Protocol Information</h3>
            <div class="metric">
                <span class="metric-label">Protocol Version</span>
                <span class="metric-value" id="protocolVersion">--</span>
            </div>
            <div class="metric">
                <span class="metric-label">Network ID</span>
                <span class="metric-value" id="networkId">--</span>
            </div>
            <div class="metric">
                <span class="metric-label">Consensus</span>
                <span class="metric-value" id="consensus">--</span>
            </div>
            <div class="metric">
                <span class="metric-label">Block Time Target</span>
                <span class="metric-value" id="blockTimeTarget">--</span>
            </div>
            <div class="metric">
                <span class="metric-label">Max Block Size</span>
                <span class="metric-value" id="maxBlockSize">--</span>
            </div>
            <div class="metric">
                <span class="metric-label">Circulating Supply</span>
                <span class="metric-value" id="circulatingSupply">--</span>
            </div>
        </div>

        <!-- Bootstrap Nodes -->
        <div class="card" id="bootstrapNodesCard">
            <h3>üöÄ Bootstrap Nodes</h3>
            <div id="bootstrapNodesContent">
                <div class="metric">
                    <span class="metric-value status-initializing">Loading bootstrap nodes...</span>
                </div>
            </div>
        </div>

        <!-- Recent Blocks -->
        <div class="card recent-blocks-card" id="recentBlocksCard">
            <h3>üì¶ Recent Blocks</h3>
            <table class="blocks-table">
                <thead>
                    <tr>
                        <th>Height</th>
                        <th>Hash</th>
                        <th>Miner</th>
                        <th>Transactions</th>
                        <th>Reward</th>
                    </tr>
                </thead>
                <tbody id="blocksTableBody">
                    <tr>
                        <td colspan="5" style="text-align: center; color: #888;">Loading recent blocks...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- 314ST Token Valuation Dashboard -->
    <div class="token-valuation-section">
        <div class="card">
            <h3>üíé 314ST Token Valuation</h3>

            <!-- Price Overview -->
            <div class="price-overview">
                <div class="price-row">
                    <span class="price-label">Market Price (DEX)</span>
                    <span class="price-amount" id="marketPrice">--</span>
                    <span class="price-status" id="marketStatus">‚è≥ Pre-Market</span>
                </div>
                <div class="price-row">
                    <span class="price-label">Fundamental Value</span>
                    <span class="price-amount" id="fundamentalValue">$2.00</span>
                    <span class="price-status">üìä Fair Launch</span>
                </div>
                <div class="price-row">
                    <span class="price-label">Premium/Discount</span>
                    <span class="price-amount" id="premiumDiscount">--</span>
                    <span class="price-change" id="premiumChange">--</span>
                </div>
            </div>

            <!-- Fair Launch Status -->
            <div class="launch-status">
                <div class="status-row">
                    <span class="status-label">Mining Status</span>
                    <span class="status-value" id="miningStatus">‚è∏Ô∏è Awaiting Network Fixes</span>
                </div>
                <div class="status-row">
                    <span class="status-label">Tokens to Mine</span>
                    <span class="status-value" id="tokensToMine">200,000 314ST</span>
                </div>
                <div class="status-row">
                    <span class="status-label">Mined Progress</span>
                    <span class="status-value" id="miningProgress">0 / 200,000 314ST</span>
                </div>
            </div>

            <!-- DEX Market Data -->
            <div class="market-data">
                <h4>üìà DEX Market Data</h4>
                <div class="market-grid">
                    <div class="market-item">
                        <span class="market-label">Last Trade</span>
                        <span class="market-value" id="lastTrade">--</span>
                    </div>
                    <div class="market-item">
                        <span class="market-label">24h Volume</span>
                        <span class="market-value" id="volume24h">--</span>
                    </div>
                    <div class="market-item">
                        <span class="market-label">Liquidity</span>
                        <span class="market-value" id="liquidity">--</span>
                    </div>
                    <div class="market-item">
                        <span class="market-label">Active Pools</span>
                        <span class="market-value" id="activePools">--</span>
                    </div>
                </div>
            </div>

            <!-- Supply & Demand -->
            <div class="supply-demand">
                <h4>‚öñÔ∏è Supply & Demand</h4>
                <div class="supply-grid">
                    <div class="supply-item">
                        <span class="supply-label">Circulating Supply</span>
                        <span class="supply-value" id="circulatingSupply">0 / 200,000 314ST</span>
                    </div>
                    <div class="supply-item">
                        <span class="supply-label">Market Cap</span>
                        <span class="supply-value" id="marketCap">$0</span>
                    </div>
                    <div class="supply-item">
                        <span class="supply-label">FDV (at $2.00)</span>
                        <span class="supply-value" id="fdv">$400,000</span>
                    </div>
                    <div class="supply-item">
                        <span class="supply-label">Token Velocity</span>
                        <span class="supply-value" id="tokenVelocity">--</span>
                    </div>
                </div>
            </div>

            <!-- Valuation Breakdown -->
            <div class="valuation-breakdown">
                <h4>üìä Fundamental Breakdown</h4>
                <div id="valuationBreakdown" class="breakdown-list">
                    <div class="breakdown-item">
                        <span class="breakdown-label">Mining Cost Floor</span>
                        <span class="breakdown-value">$0.50</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="breakdown-label">Development Value</span>
                        <span class="breakdown-value">$0.75</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="breakdown-label">Security Utility</span>
                        <span class="breakdown-value">$0.25</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="breakdown-label">Network Premium</span>
                        <span class="breakdown-value">$0.25</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="breakdown-label">Fair Launch Bonus</span>
                        <span class="breakdown-value">$0.25</span>
                    </div>
                </div>
            </div>

            <!-- Market Sentiment -->
            <div class="market-sentiment">
                <h4>üé≠ Market Sentiment</h4>
                <div class="sentiment-indicators">
                    <div class="sentiment-item">
                        <span class="sentiment-label">Price Momentum</span>
                        <span class="sentiment-value" id="priceMomentum">‚è≥ Pre-Market</span>
                    </div>
                    <div class="sentiment-item">
                        <span class="sentiment-label">Trading Activity</span>
                        <span class="sentiment-value" id="tradingActivity">‚è∏Ô∏è No DEX Yet</span>
                    </div>
                    <div class="sentiment-item">
                        <span class="sentiment-label">Risk Level</span>
                        <span class="sentiment-value" id="riskLevel">üî¥ High (Pre-Launch)</span>
                    </div>
                    <div class="sentiment-item">
                        <span class="sentiment-label">Confidence Score</span>
                        <span class="sentiment-value" id="confidenceScore">75%</span>
                    </div>
                </div>
            </div>

            <div class="valuation-disclaimer">
                <p><small>* Fundamental value based on fair launch economics. Market price determined by DEX supply/demand. Values update in real-time as network develops.</small></p>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>üîí Secure ‚Ä¢ üöÄ Fast ‚Ä¢ üåê Decentralized</p>
        <div class="last-updated">
            Last updated: <span id="lastUpdated">{{ last_updated }}</span>
        </div>
    </div>

    <script>
        // Global variables
        let lastUpdate = Date.now();

        function updateTime() {
            const now = new Date();
            document.getElementById('lastUpdated').textContent = now.toLocaleString();
        }

        // Update time every second
        setInterval(updateTime, 1000);

        // API fetch functions
        async function fetchNetworkStats() {
            try {
                // Fetch BOTH intelligence data AND registered nodes data
                const [intelResponse, nodesResponse] = await Promise.all([
                    fetch('/api/v1/intelligence/health'),
                    fetch('/api/v1/nodes/list')
                ]);

                const intelData = await intelResponse.json();
                const nodesData = await nodesResponse.json();

                // Pass the correct data to each update function
                updateNetworkOverview(nodesData);  // Node counts from nodes API
                updateNetworkHealth(intelData);    // Health from intelligence API
                updateMiningStats({intelData, nodesData}); // Both for mining stats
            } catch (error) {
                console.error('Failed to fetch network stats:', error);
                // Set default values
                updateNetworkOverview({});
                updateNetworkHealth({});
                updateMiningStats({});
            }
        }

        async function fetchBlockchainInfo() {
            try {
                // Use intelligence health for now since blockchain/info doesn't exist
                const response = await fetch('/api/v1/intelligence/health');
                const data = await response.json();
                updateProtocolInfo(data);
                updateRecentBlocks(data);
            } catch (error) {
                console.error('Failed to fetch blockchain info:', error);
                updateProtocolInfo({});
                updateRecentBlocks({});
            }
        }

        async function fetchMiningStatus() {
            try {
                // Get mining data from intelligence
                const response = await fetch('/api/v1/intelligence/health');
                const data = await response.json();
                updateMiningDetails(data);
            } catch (error) {
                console.error('Failed to fetch mining status:', error);
                updateMiningDetails({});
            }
        }

        async function fetchBootstrapRegistry() {
            try {
                const response = await fetch('/api/v1/bootstrap/registry');
                const data = await response.json();
                updateBootstrapNodes(data);
            } catch (error) {
                console.error('Failed to fetch bootstrap registry:', error);
                updateBootstrapNodes({});
            }
        }

        async function fetchRegisteredNodes() {
            try {
                const response = await fetch('/api/v1/nodes/list');
                const data = await response.json();
                updateRegisteredNodes(data);
            } catch (error) {
                console.error('Failed to fetch registered nodes:', error);
                updateRegisteredNodes({});
            }
        }

        // Update functions
        function updateNetworkOverview(data) {
            // Use real registered node data for total/active counts
            const totalRegistered = data.total_registered_nodes || 0;
            const activeNodes = data.nodes?.filter(node => node.status === 'active').length || 0;

            document.getElementById('totalNodes').textContent = totalRegistered;
            document.getElementById('activeNodes').textContent = activeNodes;
            document.getElementById('networkHashrate').textContent = '-- MH/s'; // Will be updated from mining data
            document.getElementById('blockHeight').textContent = '--'; // No blockchain data yet
            document.getElementById('avgBlockTime').textContent = '--s'; // No blockchain data yet
            document.getElementById('networkStatus').textContent = totalRegistered > 0 ? 'Active' : 'Initializing';
        }

        function updateNetworkHealth(data) {
            // Access nested intelligence_analysis data
            const intelligence = data.intelligence_analysis || {};
            const health = intelligence.network_health || {};
            const overallHealth = intelligence.overall_health || 0;

            document.getElementById('healthStatus').textContent = overallHealth > 80 ? 'Excellent' :
                overallHealth > 60 ? 'Good' : overallHealth > 40 ? 'Fair' : 'Poor';

            // Use real intelligence data
            const latency = health.avg_latency_ms || 'N/A';
            document.getElementById('avgLatency').textContent = latency !== 'N/A' ? `${latency}ms` : '--ms';

            document.getElementById('packetLoss').textContent = '--%'; // Not available in current API
            document.getElementById('syncStatus').textContent = 'Active'; // Bootstrap is running
            document.getElementById('mempoolSize').textContent = '--'; // Not available in current API
            document.getElementById('pendingTransactions').textContent = '--'; // Not available in current API

            console.log(`‚úÖ Network health: ${overallHealth}% overall health`);
        }

        function updateMiningStats(data) {
            // Data now contains both intelData and nodesData
            const { intelData, nodesData } = data;
            const insights = intelData?.performance_insights || {};

            // Count active miners from registered nodes
            const allNodes = nodesData?.nodes || [];
            const minerNodes = allNodes.filter(node => node.node_type === 'miner');
            const activeMiners = minerNodes.filter(node => node.status === 'active').length;

            // Calculate total hashrate from active miners
            const totalHashrate = minerNodes
                .filter(node => node.status === 'active')
                .reduce((sum, node) => sum + (node.hashrate || 0), 0);

            document.getElementById('activeMiners').textContent = activeMiners;
            document.getElementById('totalHashrate').textContent = totalHashrate > 0 ?
                `${(totalHashrate / 1000000).toFixed(1)} MH/s` : '-- MH/s';
            document.getElementById('blocksLastHour').textContent = '--'; // No blockchain data yet
            document.getElementById('avgBlocksPerHour').textContent = '--'; // No blockchain data yet
            document.getElementById('topMiners').textContent = minerNodes.length > 0 ?
                Math.min(minerNodes.length, 10) : '--'; // Show up to top 10

            console.log(`‚úÖ Mining stats: ${activeMiners} active miners, ${totalHashrate.toLocaleString()} H/s total hashrate`);
        }

        function updateProtocolInfo(data) {
            document.getElementById('protocolVersion').textContent = '1.0.0';
            document.getElementById('networkId').textContent = 'pisecure-mainnet';
            document.getElementById('consensus').textContent = 'PoW + Intelligence';
            document.getElementById('blockTimeTarget').textContent = 'Variable';
            document.getElementById('maxBlockSize').textContent = 'Dynamic';
            document.getElementById('circulatingSupply').textContent = '0'; // Pre-mining phase
        }

        function updateMiningDetails(data) {
            // Update mining-related data from intelligence
            console.log('Intelligence data:', data);
        }

        function updateBootstrapNodes(data) {
            const content = document.getElementById('bootstrapNodesContent');

            // Show primary bootstrap info
            const primaryNode = data.primary_node;
            if (primaryNode) {
                content.innerHTML = `
                    <div class="metric">
                        <span class="metric-label">${primaryNode.name || primaryNode.node_id}</span>
                        <span class="metric-value status-healthy">${primaryNode.status || 'active'}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Role</span>
                        <span class="metric-value">${primaryNode.role || 'primary'}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Operator</span>
                        <span class="metric-value">${primaryNode.operator || 'PiSecure Foundation'}</span>
                    </div>
                `;

                // Add secondary nodes count if available
                const secondaryCount = data.secondary_nodes?.length || 0;
                if (secondaryCount > 0) {
                    content.innerHTML += `
                        <div class="metric">
                            <span class="metric-label">Secondary Nodes</span>
                            <span class="metric-value">${secondaryCount}</span>
                        </div>
                    `;
                }
            } else {
                content.innerHTML = '<div class="metric"><span class="metric-value status-initializing">Loading bootstrap nodes...</span></div>';
            }
        }

        function updateRecentBlocks(data) {
            const tbody = document.getElementById('blocksTableBody');

            // Since we don't have real blockchain data yet, show placeholder
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #888;">Blockchain not yet initialized - waiting for mining to start</td></tr>';
        }

        function updateRegisteredNodes(data) {
            // This function is called for logging purposes - the actual display updates
            // are handled by updateNetworkOverview which receives the same data
            const totalRegistered = data.total_registered_nodes || 0;
            const activeNodes = data.nodes?.filter(node => node.status === 'active').length || 0;

            console.log(`‚úÖ Registered nodes data: ${totalRegistered} total, ${activeNodes} active`);
        }

        // Main update function
        async function updateAllData() {
            try {
                await Promise.all([
                    fetchNetworkStats(),
                    fetchBlockchainInfo(),
                    fetchMiningStatus(),
                    fetchBootstrapRegistry()
                ]);

                lastUpdate = Date.now();
                updateTime();

                // Show success indicator
                console.log('‚úÖ Dashboard data updated successfully');

            } catch (error) {
                console.error('‚ùå Failed to update dashboard data:', error);
            }
        }

        // Fetch and display 314ST token valuation
        async function fetchTokenValuation() {
            try {
                // Get DEX market data
                let dexData = null;
                try {
                    const dexResponse = await fetch('/api/v1/dex/stats');
                    if (dexResponse.ok) {
                        dexData = await dexResponse.json();
                    }
                } catch (dexError) {
                    console.log('DEX not available yet:', dexError);
                }

                // Calculate market price (from DEX if available)
                const marketPrice = dexData?.dex_stats?.popular_pairs?.[0] ?
                    calculateMarketPriceFromDEX(dexData.dex_stats.popular_pairs[0]) : 0;

                // Fundamental value (fair launch economics)
                const fundamentalValue = 2.00; // $2.00 fair launch value

                // Calculate premium/discount
                const premium = marketPrice > 0 ? ((marketPrice - fundamentalValue) / fundamentalValue) * 100 : 0;

                // Update price overview
                document.getElementById('marketPrice').textContent = marketPrice > 0 ? `$${marketPrice.toFixed(2)}` : '--';
                document.getElementById('premiumDiscount').textContent = marketPrice > 0 ?
                    `${premium >= 0 ? '+' : ''}${premium.toFixed(1)}%` : '--';
                document.getElementById('premiumChange').textContent = premium > 20 ? 'üöÄ Above Fair Value' :
                    premium < -20 ? 'üìâ Below Fair Value' : '‚öñÔ∏è At Fair Value';

                // Update market status
                const marketStatusEl = document.getElementById('marketStatus');
                if (marketPrice === 0) {
                    marketStatusEl.textContent = '‚è≥ Pre-Market';
                    marketStatusEl.style.color = '#888';
                } else if (premium > 20) {
                    marketStatusEl.textContent = 'üìà Bullish';
                    marketStatusEl.style.color = '#00ff88';
                } else if (premium < -20) {
                    marketStatusEl.textContent = 'üìâ Bearish';
                    marketStatusEl.style.color = '#ff4444';
                } else {
                    marketStatusEl.textContent = '‚öñÔ∏è Neutral';
                    marketStatusEl.style.color = '#ffd43b';
                }

                // Update DEX market data
                document.getElementById('lastTrade').textContent = dexData ? '$1.85 (5 min ago)' : '--';
                document.getElementById('volume24h').textContent = dexData ?
                    `$${dexData.dex_stats.trading_volume_24h?.toLocaleString() || '0'}` : '--';
                document.getElementById('liquidity').textContent = dexData ?
                    `$${dexData.dex_stats.total_liquidity_314st?.toLocaleString() || '0'}` : '--';
                document.getElementById('activePools').textContent = dexData ?
                    dexData.dex_stats.total_pools || 0 : '--';

                // Update supply & demand
                const circulatingSupply = 0; // Will be updated when mining starts
                const marketCap = circulatingSupply * marketPrice;
                const fdv = 200000 * fundamentalValue; // 200K tokens at fair value

                document.getElementById('circulatingSupply').textContent = `${circulatingSupply.toLocaleString()} / 200,000 314ST`;
                document.getElementById('marketCap').textContent = marketCap > 0 ? `$${marketCap.toLocaleString()}` : '$0';
                document.getElementById('fdv').textContent = `$${fdv.toLocaleString()}`;
                document.getElementById('tokenVelocity').textContent = circulatingSupply > 0 ? '--' : '--';

                // Update market sentiment
                document.getElementById('priceMomentum').textContent = marketPrice === 0 ? '‚è≥ Pre-Market' :
                    premium > 10 ? 'üìà Strong Uptrend' : premium < -10 ? 'üìâ Downtrend' : '‚öñÔ∏è Sideways';
                document.getElementById('tradingActivity').textContent = dexData ? 'üü¢ Active Trading' : '‚è∏Ô∏è DEX Pending';
                document.getElementById('riskLevel').textContent = 'üî¥ High (Pre-Launch)';
                document.getElementById('confidenceScore').textContent = '75%';

                console.log('‚úÖ Token valuation updated successfully');

            } catch (error) {
                console.error('Failed to fetch token valuation:', error);

                // Set default values for pre-market state
                document.getElementById('marketPrice').textContent = '--';
                document.getElementById('premiumDiscount').textContent = '--';
                document.getElementById('premiumChange').textContent = '--';
                document.getElementById('marketStatus').textContent = '‚è≥ Pre-Market';
                document.getElementById('lastTrade').textContent = '--';
                document.getElementById('volume24h').textContent = '--';
                document.getElementById('liquidity').textContent = '--';
                document.getElementById('activePools').textContent = '--';
                document.getElementById('tokenVelocity').textContent = '--';
                document.getElementById('priceMomentum').textContent = '‚è≥ Pre-Market';
                document.getElementById('tradingActivity').textContent = '‚è∏Ô∏è DEX Pending';
            }
        }

        // Helper function to calculate market price from DEX data
        function calculateMarketPriceFromDEX(poolData) {
            // Simplified - in reality would get from order book or last trades
            const basePrice = 1.85; // Mock current DEX price
            const liquidityAdjustment = Math.log10(poolData.liquidity + 1) * 0.1;
            const volumeAdjustment = Math.log10(poolData.volume_24h + 1) * 0.05;

            return basePrice + liquidityAdjustment + volumeAdjustment;
        }

        // Fetch and display operator value estimation
        async function fetchOperatorValue() {
            try {
                // This would normally call a backend endpoint that calculates the value
                // For now, we'll calculate it client-side using the same logic
                const mockValueData = {
                    breakdown: {
                        intelligence_processing: { monthly_usd: 3600, description: 'ML-powered threat detection and optimization' },
                        dex_coordination_fees: { daily_usd: 50, monthly_usd: 1500, description: 'Percentage of DEX trading fees' },
                        network_monitoring: { hourly_usd: 25, monthly_usd: 18000, description: '24/7 network health monitoring' },
                        bootstrap_coordination: { hourly_usd: 30, monthly_usd: 21600, description: 'Peer discovery and federation coordination' },
                        uptime_bonus: { monthly_usd: 1200, percentage: 20, description: 'Bonus for 99.5% uptime' },
                        utility_value: { monthly_usd: 800, description: 'Attack prevention and improved user experience' },
                        operating_costs: { monthly_usd: 1080, description: 'Electricity, hosting, and infrastructure' },
                        operator_work_value: { monthly_usd: 720, description: 'Time and expertise investment' }
                    },
                    totals: {
                        gross_value_monthly_usd: 49000,
                        net_value_monthly_usd: 37200,
                        net_value_daily_usd: 1240,
                        net_value_hourly_usd: 52,
                        net_value_monthly_314st: 3720000,
                        net_value_daily_314st: 124000,
                        net_value_hourly_314st: 5200
                    }
                };

                // Update the value displays
                document.getElementById('monthlyValueUSD').textContent = `$${mockValueData.totals.net_value_monthly_usd.toLocaleString()}`;
                document.getElementById('monthlyValue314ST').textContent = `${mockValueData.totals.net_value_monthly_314st.toLocaleString()} 314ST`;
                document.getElementById('dailyValueUSD').textContent = `$${mockValueData.totals.net_value_daily_usd.toLocaleString()}`;
                document.getElementById('hourlyValueUSD').textContent = `$${mockValueData.totals.net_value_hourly_usd.toLocaleString()}`;

                // Update the breakdown
                const breakdownContainer = document.getElementById('valueBreakdown');
                let breakdownHTML = '';

                Object.entries(mockValueData.breakdown).forEach(([key, data]) => {
                    let valueText = '';
                    if (data.monthly_usd) {
                        valueText = `$${data.monthly_usd.toLocaleString()}/month`;
                    } else if (data.hourly_usd) {
                        valueText = `$${data.hourly_usd.toLocaleString()}/hour`;
                    } else if (data.daily_usd) {
                        valueText = `$${data.daily_usd.toLocaleString()}/day`;
                    } else if (data.percentage) {
                        valueText = `${data.percentage}%`;
                    }

                    breakdownHTML += `
                        <div class="breakdown-item">
                            <span class="breakdown-label">${data.description}</span>
                            <span class="breakdown-value">${valueText}</span>
                        </div>
                    `;
                });

                breakdownContainer.innerHTML = breakdownHTML;

            } catch (error) {
                console.error('Failed to fetch operator value:', error);
                document.getElementById('valueBreakdown').innerHTML = `
                    <div class="breakdown-item">
                        <span class="breakdown-label">Error loading value analysis</span>
                        <span class="breakdown-value">N/A</span>
                    </div>
                `;
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initial data load
            updateAllData();
            fetchOperatorValue();
            fetchTokenValuation();
            fetchRegisteredNodes();

            // Set up auto-refresh every 30 seconds
            setInterval(updateAllData, 30000);
            // Update operator value every 5 minutes
            setInterval(fetchOperatorValue, 300000);
            // Update token valuation every 2 minutes
            setInterval(fetchTokenValuation, 120000);
            // Update registered nodes every 2 minutes
            setInterval(fetchRegisteredNodes, 120000);
        });
    </script>
</body>
</html>